<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRIDGE AI SCANNER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fdfaf6; color: #334155; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="pb-20">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pt-4">
            <h1 class="text-3xl font-black italic text-orange-500 tracking-tighter">
                <i class="fa-solid fa-utensils"></i> FRIDGE AI
            </h1>
            <button onclick="location.reload()" class="text-xs font-bold text-slate-300">RELOAD</button>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="openCamera('å†·è”µåº«')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-blue-100 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-box-open text-blue-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Fridge</span>
            </button>
            <button onclick="openCamera('å†·å‡åº«')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-cyan-100 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-snowflake text-cyan-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Freezer</span>
            </button>
            <button onclick="openCamera('é‡èœå®¤')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-green-100 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-leaf text-green-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Veggie</span>
            </button>
        </div>

        <section class="bg-white rounded-[2.5rem] p-6 card-shadow relative min-h-[400px] flex flex-col border border-orange-50">
            <div id="loading" class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center rounded-[2.5rem]">
                <i class="fa-solid fa-circle-notch fa-spin text-orange-500 text-3xl"></i>
            </div>
            
            <div id="itemList" class="flex-1 space-y-2 mb-6 overflow-y-auto max-h-[400px]">
                <p class="text-center py-20 text-slate-200 font-black italic text-xl uppercase opacity-50">No Items</p>
            </div>
            
            <button onclick="getSuggestions()" id="suggestBtn" class="w-full bg-orange-500 py-4 rounded-2xl font-black text-white shadow-xl shadow-orange-200 active:scale-95 transition-all">
                ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ï¼
            </button>
        </section>
    </div>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cameraModal" class="fixed inset-0 bg-black z-[300] hidden flex flex-col">
        <video id="video" autoplay playsinline class="flex-1 object-cover"></video>
        <div class="h-32 bg-white flex justify-around items-center rounded-t-[3rem]">
            <button onclick="closeCamera()" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            <button onclick="takeShot()" class="w-20 h-20 rounded-full border-4 border-orange-500 bg-white flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-orange-500"></div>
            </button>
            <div class="w-12"></div>
        </div>
        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <script>
        // ğŸš€ GitHub Actionsã§æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹å ´æ‰€
        const API_KEY = "__API__"; 

        let stock = [];
        let stream = null;
        let currentLoc = "";

        async function gemini(prompt, isImage = false, base64 = "") {
            // ã‚¨ãƒ©ãƒ¼åˆ¤å®šã‚’å‰Šé™¤ã€‚ç›´æ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™ãœï¼
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const parts = [{ text: prompt }];
            if (isImage) parts.push({ inlineData: { mimeType: "image/png", data: base64 } });
            
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function openCamera(loc) {
            currentLoc = loc;
            document.getElementById('cameraModal').classList.remove('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        }

        function closeCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraModal').classList.add('hidden');
        }

        async function takeShot() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/png').split(',')[1];
            closeCamera();
            
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await gemini("ç”»åƒå†…ã®é£Ÿæåã‚’JSONã§æŠ½å‡ºã—ã¦ã€‚å½¢å¼: {\"items\": [\"åå‰\"]}", true, base64);
                const data = JSON.parse(res.replace(/```json|```/g, ''));
                if (data.items) {
                    data.items.forEach(name => stock.push({ name, loc: currentLoc }));
                    render();
                }
            } catch (e) { console.error(e); }
            document.getElementById('loading').classList.add('hidden');
        }

        function render() {
            const list = document.getElementById('itemList');
            if (stock.length === 0) return;
            list.innerHTML = stock.map((item, i) => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-50 card-shadow">
                    <span class="text-sm font-bold text-slate-600">${item.name}</span>
                    <span class="text-[9px] bg-slate-50 text-slate-400 px-2 py-0.5 rounded-md font-black uppercase">${item.loc}</span>
                </div>`).join('');
        }

        async function getSuggestions() {
            if (stock.length === 0) return alert("é£Ÿæã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã‚Œï¼");
            const names = stock.map(s => s.name).join('ã€');
            alert(names + " ã‚’ä½¿ã£ãŸãƒ¬ã‚·ãƒ”ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãœã€‚");
            try {
                const res = await gemini(`${names} ã‚’ä½¿ã£ãŸç¾å‘³ã—ã„æ–™ç†ã®åå‰ã‚’1ã¤æ•™ãˆã¦ã€‚`);
                alert("AIã®ææ¡ˆ: " + res);
            } catch (e) {
                alert("APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸãœã€‚ã‚­ãƒ¼ãŒæ­£ã—ãç½®æ›ã•ã‚Œã¦ãªã„å¯èƒ½æ€§ãŒé«˜ã„ãªã€‚");
            }
        }
    </script>
</body>
</html>
