<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRIDGE AI SCANNER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fdfaf6; color: #334155; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .serving-btn.active { background-color: #f59e0b; color: white; border-color: #f59e0b; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-20">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pt-4">
            <h1 class="text-3xl font-black italic text-orange-500 tracking-tighter">
                <i class="fa-solid fa-utensils"></i> FRIDGE AI
            </h1>
            <button onclick="clearAll()" class="text-xs font-bold text-slate-300 hover:text-red-500">å…¨æ¶ˆå»</button>
        </header>

        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚­ãƒ£ãƒ³ -->
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="openCamera('å†·è”µåº«')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-blue-100 hover:border-blue-400 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-box-open text-blue-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Fridge</span>
            </button>
            <button onclick="openCamera('å†·å‡åº«')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-cyan-100 hover:border-cyan-400 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-snowflake text-cyan-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Freezer</span>
            </button>
            <button onclick="openCamera('é‡èœå®¤')" class="flex flex-col items-center p-4 bg-white rounded-3xl border-b-4 border-green-100 hover:border-green-400 active:scale-95 transition-all card-shadow">
                <i class="fa-solid fa-leaf text-green-400 text-xl mb-2"></i>
                <span class="text-[10px] font-black uppercase">Veggie</span>
            </button>
        </div>

        <!-- é£Ÿæãƒªã‚¹ãƒˆ -->
        <section class="bg-white rounded-[2.5rem] p-6 card-shadow relative min-h-[300px] flex flex-col border border-orange-50">
            <div id="loading" class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center rounded-[2.5rem]">
                <i class="fa-solid fa-circle-notch fa-spin text-orange-500 text-3xl"></i>
            </div>

            <div class="flex gap-2 mb-6">
                <input id="manualInput" type="text" placeholder="é£Ÿæåã‚’å…¥åŠ›..." class="flex-1 bg-slate-100 rounded-2xl px-5 py-3 outline-none text-sm font-bold">
                <button onclick="addManual()" class="bg-orange-500 text-white w-12 rounded-2xl flex items-center justify-center active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="itemList" class="flex-1 space-y-2 overflow-y-auto max-h-[350px] custom-scrollbar mb-6"></div>

            <button onclick="getSuggestions()" id="suggestBtn" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 py-4 rounded-2xl font-black text-white shadow-xl shadow-orange-200 active:scale-95 transition-all disabled:opacity-50">
                ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ï¼
            </button>
        </section>

        <div id="suggestionArea" class="mt-8 space-y-3 hidden">
            <p class="text-[10px] font-black text-slate-300 text-center uppercase tracking-[0.2em]">AI Recommended Dishes</p>
            <div id="suggestionList" class="grid gap-3"></div>
        </div>
    </div>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cameraModal" class="fixed inset-0 bg-black z-[300] hidden flex flex-col">
        <video id="video" autoplay playsinline class="flex-1 object-cover"></video>
        <div class="h-32 bg-white flex justify-around items-center rounded-t-[3rem] px-8">
            <button onclick="closeCamera()" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            <button onclick="takeShot()" class="w-20 h-20 rounded-full border-4 border-orange-500 bg-white flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-orange-500"></div>
            </button>
            <div class="w-12"></div>
        </div>
        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <!-- ãƒ¬ã‚·ãƒ”è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="recipeModal" class="fixed inset-0 bg-[#fdfaf6] z-[400] hidden flex flex-col animate-in fade-in duration-200">
        <header class="p-6 bg-white border-b flex flex-col gap-4">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="recipeTitle" class="text-2xl font-black text-slate-800 tracking-tight">æ–™ç†å</h2>
                    <div class="flex gap-3 mt-1 text-[10px] font-bold text-orange-500 uppercase tracking-widest">
                        <span id="recipeTime"><i class="fa-regular fa-clock"></i> --åˆ†</span>
                        <span id="recipeDifficulty"><i class="fa-solid fa-fire"></i> --</span>
                    </div>
                </div>
                <button onclick="closeRecipe()" class="p-3 bg-slate-100 rounded-2xl hover:bg-red-50 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] font-black text-slate-400 uppercase">Servings:</span>
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button onclick="changeServings(1)" id="serv-1" class="serving-btn px-4 py-1.5 rounded-lg text-xs font-bold active">1äººå‰</button>
                    <button onclick="changeServings(2)" id="serv-2" class="serving-btn px-4 py-1.5 rounded-lg text-xs font-bold">2äººå‰</button>
                    <button onclick="changeServings(4)" id="serv-4" class="serving-btn px-4 py-1.5 rounded-lg text-xs font-bold">4äººå‰</button>
                </div>
            </div>
        </header>

        <div id="recipeContent" class="flex-1 overflow-y-auto p-6 custom-scrollbar">
            <div id="recipeDetail"></div>
            <!-- ãƒãƒ£ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-12 pt-8 border-t-2 border-dashed border-slate-200 pb-10">
                <p class="text-[10px] font-black text-slate-400 mb-6 uppercase tracking-widest text-center">Ask AI Chef</p>
                <div id="chatMessages" class="space-y-4 mb-6"></div>
                <div class="flex gap-2 bg-white p-2 rounded-3xl border shadow-sm">
                    <input id="chatInput" type="text" placeholder="è³ªå•ã‚’å…¥åŠ›..." class="flex-1 px-4 py-2 text-sm outline-none bg-transparent">
                    <button onclick="sendChat()" class="bg-orange-500 text-white w-10 h-10 rounded-2xl flex items-center justify-center active:scale-90 transition-transform"><i class="fa-solid fa-paper-plane text-sm"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ğŸ”‘ API Key Injection Point ---
        // GitHub Actionsç­‰ã§ "__API__" ã‚’å®Ÿéš›ã®ã‚­ãƒ¼ã«ç½®æ›ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’æƒ³å®š
        const API_KEY = "__API__"; 

        let stock = [];
        let stream = null;
        let activeDish = "";
        let activeServings = 1;
        let currentTarget = "";

        async function gemini(prompt, isImage = false, base64 = "") {
            if (API_KEY === "__API__" || !API_KEY) {
                console.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚GitHub Secretsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                alert("APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return null;
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const parts = [{ text: prompt }];
            if (isImage) parts.push({ inlineData: { mimeType: "image/png", data: base64 } });
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts }] })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error("API Error:", e);
                return null;
            }
        }

        function renderStock() {
            const list = document.getElementById('itemList');
            list.innerHTML = stock.length === 0 ? '<div class="text-center py-16 text-slate-300 text-xs font-bold animate-pulse italic">å†·è”µåº«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>' : 
                stock.map((item, i) => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 card-shadow animate-in slide-in-from-left-2 transition-all">
                    <span class="text-sm font-bold text-slate-600">${item.name} <span class="text-[9px] bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full ml-1 font-black uppercase">${item.loc}</span></span>
                    <button onclick="removeItem(${i})" class="text-slate-200 hover:text-red-400 transition-colors"><i class="fa-solid fa-circle-xmark text-lg"></i></button>
                </div>`).join('');
            document.getElementById('suggestBtn').disabled = stock.length === 0;
        }

        function addManual() {
            const input = document.getElementById('manualInput');
            if (!input.value.trim()) return;
            stock.push({ name: input.value.trim(), loc: 'Manual' });
            input.value = '';
            renderStock();
        }

        function removeItem(i) { stock.splice(i, 1); renderStock(); }
        function clearAll() { if(confirm("é£Ÿæã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { stock = []; renderStock(); document.getElementById('suggestionArea').classList.add('hidden'); } }

        async function openCamera(loc) {
            currentTarget = loc;
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
            } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); closeCamera(); }
        }

        function closeCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraModal').classList.add('hidden');
        }

        async function takeShot() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/png').split(',')[1];
            closeCamera();
            
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await gemini("ç”»åƒå†…ã®é£Ÿæåã‚’æŠ½å‡ºã—ã¦JSONã§è¿”ã—ã¦ã€‚å½¢å¼: {\"items\": [\"åå‰\"]}", true, base64);
                const data = JSON.parse(res.replace(/```json|```/g, ''));
                if (data.items) {
                    data.items.forEach(name => stock.push({ name, loc: currentTarget }));
                    renderStock();
                }
            } catch (e) { alert("é£Ÿæã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
            document.getElementById('loading').classList.add('hidden');
        }

        async function getSuggestions() {
            const btn = document.getElementById('suggestBtn');
            btn.disabled = true; btn.innerText = "çŒ®ç«‹ã‚’ä½œæˆä¸­...";
            try {
                const list = stock.map(s => s.name).join(',');
                const res = await gemini(`é£Ÿæ [${list}] ã‚’æ´»ç”¨ã—ãŸãƒ¬ã‚·ãƒ”ã‚’3ã¤ææ¡ˆã—ã¦ã€‚JSONå½¢å¼: {"dishes": [{"name": "æ–™ç†å", "desc": "èª¬æ˜"}]}`);
                const data = JSON.parse(res.replace(/```json|```/g, ''));
                
                document.getElementById('suggestionArea').classList.remove('hidden');
                document.getElementById('suggestionList').innerHTML = data.dishes.map(d => `
                    <button onclick="showRecipe('${d.name}')" class="w-full bg-white p-5 rounded-3xl border-2 border-slate-100 text-left hover:border-orange-400 active:scale-[0.98] transition-all card-shadow group">
                        <div class="flex justify-between items-center">
                            <div class="flex-1 pr-4">
                                <div class="font-black text-slate-700">${d.name}</div>
                                <div class="text-[10px] text-slate-400 mt-1 line-clamp-1">${d.desc}</div>
                            </div>
                            <div class="bg-orange-50 text-orange-500 px-4 py-2 rounded-xl text-[10px] font-black group-hover:bg-orange-500 group-hover:text-white transition-all">ä½œã‚‹ï¼</div>
                        </div>
                    </button>
                `).join('');
                document.getElementById('suggestionArea').scrollIntoView({ behavior: 'smooth' });
            } catch (e) { alert("ææ¡ˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
            btn.disabled = false; btn.innerText = "ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ï¼";
        }

        async function showRecipe(name, update = false) {
            activeDish = name;
            document.getElementById('recipeModal').classList.remove('hidden');
            if (!update) {
                document.getElementById('recipeTitle').innerText = name;
                document.getElementById('chatMessages').innerHTML = "";
            }
            const detail = document.getElementById('recipeDetail');
            detail.innerHTML = "<div class='py-20 text-center font-bold text-slate-300 animate-pulse'>AI Chef is writing...</div>";
            
            try {
                const res = await gemini(`æ–™ç†ã€Œ${name}ã€ã®ãƒ¬ã‚·ãƒ”ã‚’ã€Œ${activeServings}äººå‰ã€ã§ä½œæˆã€‚ææ–™(åˆ†é‡è¾¼)ã¨æ‰‹é †ã‚’JSONã§ã€‚JSONå½¢å¼: {"time": "æ™‚é–“", "diff": "é›£æ˜“åº¦", "ing": ["ææ–™ åˆ†é‡"], "steps": ["æ‰‹é †"]}`);
                const data = JSON.parse(res.replace(/```json|```/g, ''));
                document.getElementById('recipeTime').innerHTML = `<i class="fa-regular fa-clock"></i> ${data.time}`;
                document.getElementById('recipeDifficulty').innerHTML = `<i class="fa-solid fa-fire"></i> ${data.diff}`;
                detail.innerHTML = `
                    <section class="mb-10 animate-in fade-in slide-in-from-bottom-2">
                        <h3 class="text-xs font-black text-orange-500 mb-4 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-basket-shopping"></i> ææ–™ (${activeServings}äººå‰)</h3>
                        <div class="grid grid-cols-2 gap-2">${data.ing.map(i => `<div class="bg-white p-3 rounded-2xl text-[11px] font-bold border border-slate-50 card-shadow">${i}</div>`).join('')}</div>
                    </section>
                    <section class="animate-in fade-in slide-in-from-bottom-4">
                        <h3 class="text-xs font-black text-orange-500 mb-4 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> ä½œã‚Šæ–¹</h3>
                        <div class="space-y-4">${data.steps.map((s, i) => `<div class="flex gap-4 p-5 bg-white rounded-3xl border border-slate-50 card-shadow"><span class="w-6 h-6 rounded-full bg-orange-500 text-white flex items-center justify-center text-[10px] font-black shrink-0 shadow-lg shadow-orange-200">${i+1}</span><p class="text-[11px] font-bold text-slate-600 leading-relaxed">${s}</p></div>`).join('')}</div>
                    </section>
                `;
            } catch (e) { detail.innerHTML = "<p class='text-center text-red-400 font-bold'>ãƒ¬ã‚·ãƒ”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>"; }
        }

        function changeServings(n) {
            activeServings = n;
            document.querySelectorAll('.serving-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`serv-${n}`).classList.add('active');
            showRecipe(activeDish, true);
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            if (!input.value.trim()) return;
            const msg = input.value.trim();
            input.value = "";
            const box = document.getElementById('chatMessages');
            box.innerHTML += `<div class="flex justify-end"><div class="bg-slate-800 text-white p-3 px-5 rounded-2xl rounded-tr-none text-[11px] font-bold shadow-lg">${msg}</div></div>`;
            
            try {
                const res = await gemini(`æ–™ç†ã€Œ${activeDish}ã€ã«ã¤ã„ã¦ã®è³ªå•: ${msg}\nå›ç­”ã¯çŸ­ãã€è¦ªåˆ‡ã«ã€‚`);
                box.innerHTML += `<div class="flex justify-start animate-in slide-in-from-left-2"><div class="bg-white text-slate-600 p-3 px-5 rounded-2xl rounded-tl-none text-[11px] font-bold border card-shadow">${res}</div></div>`;
            } catch (e) { box.innerHTML += `<div class="text-center text-[10px] text-red-400 font-bold">é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>`; }
            document.getElementById('recipeContent').scrollTo({ top: box.scrollHeight + 1000, behavior: 'smooth' });
        }

        function closeRecipe() { document.getElementById('recipeModal').classList.add('hidden'); }
        
        // Enterã‚­ãƒ¼å¯¾å¿œ
        document.getElementById('manualInput').addEventListener('keypress', e => e.key === 'Enter' && addManual());
        document.getElementById('chatInput').addEventListener('keypress', e => e.key === 'Enter' && sendChat());
        
        renderStock();
    </script>
</body>
</html>